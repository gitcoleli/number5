version: 2.1

orbs:
  aws-ecr: circleci/aws-ecr@6.15.3

    
jobs:

# ##########################Building Section #################################################################################################

  build-app:
    build:
    docker:
      - image: python:3.9-alpine
    working_directory: ~/repo
    steps:
      - checkout
      - attach_workspace:
                    at: ~/
      - run:
                name: Install dependencies
                command: |
                        pip install -r requirements.txt
                        pip list
                        ls

#######################################linting the Application##################################################################################

  lint-app:
    build:
    docker:
      - image: python:3.9-alpine
    working_directory: ~/repo
    steps:
      - checkout
      - attach_workspace:
                    at: ~/
      - run:
                name: Install dependencies
                command: |
                        pip install -r requirements.txt
                        pip list
      - run:
                name: lint app
                command: |
                        pylint --disable=R,C,W1203 app.py                                                

###############################################vulnerability Scanning the alplication ###############################################################

  scan-app:
    build:
    docker:
      - image: python:3.9-alpine
    working_directory: ~/repo
    steps:
      - checkout
      - attach_workspace:
                    at: ~/
      - run:
                name: Install dependencies
                command: |
                        pip install --upgrade pip
                        pip install -r requirements.txt
                        safety check

###################################################docker build ###############################################################

  # ecr-upload:
  #   build:
  #   docker:
  #     - image: python:3.9-alpine
  #   working_directory: ~/repo
  #   steps:
  #     - checkout
  #     - attach_workspace:
  #                   at: ~/

  #     - run:
  #               name: Install docker
  #               command: |
  #                       apk add docker-cli
  #                       docker image ls


  #     - run:
  #               name: Install dependencies
  #               command: |
  #                       pip install --upgrade pip
  #                       pip install awscli
  #                       pip install -r requirements.txt

  #     - run:
  #               name: push to ecr
  #               command: |
  #                       aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws/r3i6g3s9
  #                       docker build -t number5 .
  #                       docker tag number5:latest public.ecr.aws/r3i6g3s9/number5:latest.${CIRCLE_BUILD_NUM}
  #                       docker push public.ecr.aws/r3i6g3s9/number5:latest.${CIRCLE_BUILD_NUM}



workflows:
  default:
    jobs:
      - build-app
      - lint-app:
          requires: [build-app]
      - scan-app:
          requires: [lint-app]
      # - ecr-upload:
      #     requires: [scan-app]
      - aws-ecr/build-and-push-image:
          setup-remote-docker: true
          remote-docker-version: 19.03.13
          remote-docker-layer-caching: true
          docker-login: true
          repo: number5
          tag: "latest,v0.1.${CIRCLE_BUILD_NUM}"
          dockerfile: Dockerfile
          path: .
          requires: [scan-app]

